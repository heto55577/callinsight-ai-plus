<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallInsight AI+ - –î–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏–∑–∞ –∑–≤–æ–Ω–∫–∞</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        .dashboard-container {
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }
        
        .dashboard-card h5 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .wordcloud-img {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }
        
        .metrics-table {
            margin-top: 10px;
        }
        
        .recommendations-list {
            list-style-type: none;
            padding-left: 0;
        }
        
        .recommendations-list li {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
        
        .header-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .emotion-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin: 5px;
        }
        
        .back-button {
            margin-bottom: 20px;
        }
        
        .plotly-graph-div {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .emotion-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .emotion-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .metric-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            margin: 10px 0;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .keyword-cloud .badge {
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .keyword-cloud .badge:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* CSS –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç–º–æ—Ü–∏–π */
        .emotion-anger { background-color: #e74c3c; }
        .emotion-joy { background-color: #2ecc71; }
        .emotion-sadness { background-color: #3498db; }
        .emotion-fear { background-color: #9b59b6; }
        .emotion-surprise { background-color: #e67e22; }
        .emotion-neutral { background-color: #95a5a6; }
    </style>
</head>
<body>
    <!-- Hidden div –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ JavaScript -->
    <div id="callData" 
         data-call='{{ call_data|tojson|safe }}'
         style="display: none;">
    </div>
    
    <div class="dashboard-container">
        <div class="back-button">
            <a href="/" class="btn btn-outline-primary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∑–≤–æ–Ω–∫–æ–≤
            </a>
        </div>
        
        <!-- –®–∞–ø–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–≤–æ–Ω–∫–µ -->
        <div class="header-info">
            <div class="row">
                <div class="col-md-6">
                    <h3>üìû –ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞ #{{ call_data.call_id }}</h3>
                    <p class="mb-1"><strong>–î–∞—Ç–∞:</strong> {{ call_data.date }}</p>
                    <p class="mb-1"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ call_data.duration }}</p>
                    <p class="mb-0">
                        <strong>–î–æ–º–∏–Ω–∏—Ä—É—é—â–∞—è —ç–º–æ—Ü–∏—è:</strong>
                        <span class="emotion-badge emotion-{{ call_data.dominant_emotion_class }}">
                            {{ call_data.dominant_emotion|upper }}
                        </span>
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    {% if call_data.total_profanity_count > 3 %}
                    <div class="alert alert-danger">
                    {% elif call_data.total_profanity_count > 0 %}
                    <div class="alert alert-warning">
                    {% else %}
                    <div class="alert alert-success">
                    {% endif %}
                        <h5>üö´ –ù–µ—Ü–µ–Ω–∑—É—Ä–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞</h5>
                        <p class="mb-0">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: {{ call_data.total_profanity_count }} —Å–ª—É—á–∞–µ–≤</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –î–∞—à–±–æ—Ä–¥ -->
        {{ dashboard_html|safe }}
        
        <!-- –ë–ª–æ–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ -->
        <div class="dashboard-card">
            <h5>üìù –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–¢–æ–ø-10):</h6>
                    <div class="keyword-cloud">
                        {% for keyword in call_data.keywords %}
                        <span class="badge bg-info text-dark m-1 p-2">{{ keyword }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:</h6>
                    <ul>
                        <li><strong>–î–∞—Ç—ã:</strong> 2024-03-15</li>
                        <li><strong>–°—É–º–º—ã:</strong> 5000 —Ä—É–±</li>
                        <li><strong>–ù–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤:</strong> A-12345</li>
                        <li><strong>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</strong> +7 (XXX) XXX-XX-XX</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- –≠–∫—Å–ø–æ—Ä—Ç –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="dashboard-card">
            <div class="row">
                <div class="col-md-6">
                    <h6>üì§ –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h6>
                    <button class="btn btn-outline-primary me-2" onclick="exportPDF()">
                        üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
                    </button>
                    <button class="btn btn-outline-success me-2" onclick="exportJSON()">
                        üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportCSV()">
                        üìà –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <h6>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
                    <button class="btn btn-danger me-2" onclick="escalateIncident()">
                        üö® –≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç
                    </button>
                    <button class="btn btn-warning me-2" onclick="scheduleCallback()">
                        üìû –û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                    </button>
                    <button class="btn btn-info" onclick="addToTraining()">
                        üë®‚Äçüè´ –î–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—É—á–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ü–û–°–û–ë: –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
        const callDataElement = document.getElementById('callData');
        const callData = JSON.parse(callDataElement.getAttribute('data-call'));
        
        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
        console.log('–î–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∞:', callData);
        
        function exportPDF() {
            alert('–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∑–∂–µ');
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF
        }
        
        function exportJSON() {
            try {
                const dataStr = JSON.stringify(callData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = 'call_analysis_' + callData.call_id + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                console.log('–§–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω:', exportFileDefaultName);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ JSON: ' + error.message);
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
            }
        }
        
        function exportCSV() {
            alert('–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∑–∂–µ');
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV
        }
        
        function escalateIncident() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∏–Ω—Ü–∏–¥–µ–Ω—Ç? –ü–∏—Å—å–º–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É.')) {
                alert('–ò–Ω—Ü–∏–¥–µ–Ω—Ç —ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω. –ú–µ–Ω–µ–¥–∂–µ—Ä –±—É–¥–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω.');
                console.log('–ò–Ω—Ü–∏–¥–µ–Ω—Ç —ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∑–≤–æ–Ω–∫–∞:', callData.call_id);
            }
        }
        
        function scheduleCallback() {
            const time = prompt('–í–≤–µ–¥–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∑–∞–≤—Ç—Ä–∞ –≤ 14:00"):');
            if (time) {
                alert(`–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞: ${time}`);
                console.log('–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞:', time);
            }
        }
        
        function addToTraining() {
            if (confirm('–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫ –≤ –±–∞–∑—É –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤?')) {
                alert('–ó–≤–æ–Ω–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —É—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.');
                console.log('–ó–≤–æ–Ω–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ–±—É—á–µ–Ω–∏–µ:', callData.call_id);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è CSS –∫–ª–∞—Å—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
        function applyDynamicStyles() {
            // –ù–∞—Ö–æ–¥–∏–º –±–µ–π–¥–∂ —ç–º–æ—Ü–∏–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª–∞—Å—Å
            const emotionBadge = document.querySelector('.emotion-badge');
            if (emotionBadge) {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —ç–º–æ—Ü–∏–π
                emotionBadge.classList.remove('emotion-anger', 'emotion-joy', 'emotion-sadness', 
                                             'emotion-fear', 'emotion-surprise', 'emotion-neutral');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å –∏–∑ callData
                const emotionClass = callData.dominant_emotion_class || 'neutral';
                emotionBadge.classList.add('emotion-' + emotionClass);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            const keywordBadges = document.querySelectorAll('.keyword-cloud .badge');
            keywordBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    const keyword = this.textContent;
                    alert(`–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ: "${keyword}"\n\n–≠—Ç–æ —Å–ª–æ–≤–æ –≤—Å—Ç—Ä–µ—á–∞–ª–æ—Å—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∂–∞–ª–æ–±—ã –∫–ª–∏–µ–Ω—Ç–∞.`);
                });
            });
        }
        
        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', applyDynamicStyles);
        
        // –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function createSimpleChart() {
            if (!callData.emotion_stats) return;
            
            const emotions = Object.keys(callData.emotion_stats);
            const values = Object.values(callData.emotion_stats);
            
            const colors = {
                '—Ä–∞–¥–æ—Å—Ç—å': '#2ecc71',
                '–≥–Ω–µ–≤': '#e74c3c',
                '–≥—Ä—É—Å—Ç—å': '#3498db',
                '—Å—Ç—Ä–∞—Ö': '#9b59b6',
                '—É–¥–∏–≤–ª–µ–Ω–∏–µ': '#e67e22',
                '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ': '#95a5a6'
            };
            
            const chartColors = emotions.map(emotion => colors[emotion] || '#95a5a6');
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const chartHtml = `
            <div class="dashboard-card">
                <h5>üìä –ì—Ä–∞—Ñ–∏–∫ —ç–º–æ—Ü–∏–π (–¥–µ–º–æ)</h5>
                <div style="padding: 20px;">
                    ${emotions.map((emotion, i) => `
                        <div class="mb-2">
                            <strong>${emotion}:</strong> ${values[i]}%
                            <div class="progress">
                                <div class="progress-bar" 
                                     style="width: ${values[i]}%; background-color: ${chartColors[i]};">
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            `;
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ –¥–∞—à–±–æ—Ä–¥
            const dashboardContainer = document.querySelector('.dashboard-container');
            if (dashboardContainer) {
                dashboardContainer.insertAdjacentHTML('afterbegin', chartHtml);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', createSimpleChart);
    </script>
</body>
</html>